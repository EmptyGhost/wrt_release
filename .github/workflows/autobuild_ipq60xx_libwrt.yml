name: Auto Release JDCloud IPQ60XX Libwrt
# 这里的名字可以区分原版手动流程
run-name: Auto Release - jdcloud_ipq60xx_libwrt

on:
  # 允许手动触发（方便测试，无需参数）
  workflow_dispatch:
  # 定时触发：每周一 UTC时间 0:00 (即北京时间 8:00)
  schedule:
    - cron: '0 0 * * 1'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # 【核心修改】在这里定义固定的机型名称，替代原来的 inputs
  MODEL: jdcloud_ipq60xx_libwrt

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-24.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Free disk space
        uses: sbwml/actions@free-disk

      - name: Build System Setup
        run: |
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix
          sudo -E apt -yqq install libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E systemctl daemon-reload

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Build Date and Timezone
        run: |
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          export BUILD_DATE=$(TZ=UTC-8 date +"%y.%m.%d_%H.%M.%S")
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          # 【修改】将 inputs.model 替换为 env.MODEL
          export BUILD_SRC=$(awk -F"=" '/REPO_URL/ {print $NF}' "./compilecfg/${{ env.MODEL }}.ini")
          echo "BUILD_SRC=$BUILD_SRC" >> $GITHUB_ENV

      - name: Pre Clone
        # 【修改】将 inputs.model 替换为 env.MODEL
        run: ./pre_clone_action.sh ${{ env.MODEL }}

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ./action_build/.ccache
            ./action_build/staging_dir
          key: ${{ matrix.os }}-${{ hashFiles('**/repo_flag') }}-${{ env.BUILD_DATE }}
          restore-keys: |
            ${{ matrix.os }}-${{ hashFiles('**/repo_flag') }}-

      - name: Refresh the cache
        run: |
          if [ -d "./action_build/staging_dir" ]; then
            find "./action_build/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
                find "$dir" -type f -exec touch {} +
            done
          fi

      - name: Build Firmware
        # 【修改】将 inputs.model 替换为 env.MODEL
        run: ./build.sh ${{ env.MODEL }}

      - name: Get Kernel Verion
        run: |
          # 获取内核版本
          echo "KVER=$(grep -oP "^kernel.*" ./firmware/*.manifest | grep -oP "[4-6]\.[0-9]{1,3}\.[0-9]{1,3}")" >> $GITHUB_ENV

      - name: Delete Old Cache
        run: |
          # 获取缓存列表并删除
          gh cache list --key ${{ matrix.os }}-${{ hashFiles('**/repo_flag') }}- --json key --jq '.[] | .key' | while read -r key; do
            gh cache delete "$key"
          done
          # 输出缓存状态
          echo "========cache status========"
          echo "ccache: $(du -sh ./action_build/.ccache | cut -f 1)"
          echo "staging: $(du -sh ./action_build/staging_dir | cut -f 1)"

      - name: Machine Information
        run: |
          echo "=============================================="
          lscpu | grep -E "name|Core|Thread"
          echo "=============================================="
          df -h
          echo "=============================================="

      # 【移除】删除了针对 n1_immwrt 的 Package OpenWrt Firmware 步骤
      # 因为当前固定机型不是 n1，该步骤永远不会执行，删除可保持代码整洁。

      - name: Prepare Release Body
        run: |
          echo "云编译发布" > release_body.txt
          echo "源码：${{ env.BUILD_SRC }}" >> release_body.txt
          echo "Kernel: ${{ env.KVER }}" >> release_body.txt
          echo "WIFI密码: 12345678" >> release_body.txt
          echo "LAN地址: 192.168.1.1" >> release_body.txt
          echo "插件：" >> release_body.txt
          echo "$(grep -oP "luci-app(-[a-zA-Z0-9]{1,}){1,}" ./firmware/*.manifest | awk -F":" '{print $NF}')"  >> release_body.txt

      - name: Release Firmware
        uses: softprops/action-gh-release@v2
        with:
          # 【修改】将 inputs.model 替换为 env.MODEL
          tag_name: ${{ env.BUILD_DATE }}_${{ env.MODEL }}
          # 【简化】由于不是 n1 机型，直接指定 firmware 目录，移除了三元表达式
          files: ./firmware/*.*
          body_path: ./release_body.txt
